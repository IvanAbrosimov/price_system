name: Build Price Catalog

on:
  # Ручной запуск из GitHub
  workflow_dispatch:
  
  # Webhook от Google Apps Script или Telegram
  repository_dispatch:
    types: [build-price]

# Отменяет предыдущую сборку если запускается новая
concurrency:
  group: build-price
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt
      
      - name: Run build script
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
          USE_GOOGLE_DRIVE: 'true'
        run: |
          cd scripts
          python build.py
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: price-files
          path: output/
          retention-days: 7
